<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mythic</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        html,
        body {
            font-family: "Work Sans", Helvetica, sans-serif;
            padding-top: 50px;
        }

        .icon-container {
            position: relative;
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 25px;
        }

        .icon-centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: -1px 1px 0 #000,
                1px 1px 0 #000,
                1px -1px 0 #000,
                -1px -1px 0 #000;
        }

        .bg-priest {
            background-color: white !important;
        }

        .bg-druid {
            background-color: orange !important;
        }

        .bg-mage {
            background-color: lightblue !important;
        }

        .bg-warlock {
            background-color: purple !important;
        }

        .bg-paladin {
            background-color: pink !important;
        }

        .bg-rogue {
            background-color: yellow !important;
        }

        #combinationsTable img {
            border-radius: 10px;
            width: 40px;
        }

        #combinationsTable span {
            margin-right: 2px;
        }

        #combinationsTable tr td:nth-child(1) {
            width: 300px;
        }

        #combinationsTable tr td:nth-child(2) {
            width: 1px;
            text-align: right;
        }

        #combinationsTable tr td:nth-child(3) {
            width: 370px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-2">
                Player1
            </div>
            <div class="col-10">
                <select class="select2 specSelect p1" multiple="multiple"></select>
            </div>
            <div class="col-2">
                Player2
            </div>
            <div class="col-10">
                <select class="select2 specSelect p2" multiple="multiple"></select>
            </div>
            <div class="col-2">
                Player3
            </div>
            <div class="col-10">
                <select class="select2 specSelect p3" multiple="multiple"></select>
            </div>
            <div class="col-2">
                Player4
            </div>
            <div class="col-10">
                <select class="select2 specSelect p4" multiple="multiple"></select>
            </div>
            <div class="col-2">
                Player5
            </div>
            <div class="col-10">
                <select class="select2 specSelect p5" multiple="multiple"></select>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <p id="compCount"></p>
                <table id="combinationsTable" class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Setup</th>
                            <th>IPM</th>
                            <th>Buffs</th>
                            <th>Util</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</body>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {

        var specOptions = $.map(classesJson, function (c) {
            return $.map(c.specs, function (s) {
                var option = s.name + ' ' + c.name;
                return {
                    id: [s.role, c.name, s.name].join('_').replace(' ', '_').toLowerCase(),
                    text: option,
                    class: c.name.toLowerCase(),
                    spec: s.name.toLowerCase(),
                    role: s.role
                }
            })
        });

        $('.select2').select2({
            width: '100%',
            data: specOptions,
            templateSelection: function (data) {
                $(data.element).attr('data-normalized', data.id);
                return data.text;
            }
        });

        $('.select2.p1').val(['tank_demon_hunter_vengeance', 'tank_druid_guardian']).trigger('change');
        $('.select2.p2').val(['healer_priest_discipline']).trigger('change');
        $('.select2.p3').val(['melee_rogue_outlaw', 'melee_demon_hunter_havoc']).trigger('change');
        $('.select2.p4').val(['melee_paladin_retribution']).trigger('change');
        $('.select2.p5').val(['ranged_druid_balance', 'ranged_mage_fire', 'healer_druid_restoration']).trigger('change');

        DoWork();
        $('.select2').on('change', (e) => DoWork());
    });


    function DoWork() {
        ApplyClassColorsToSelected();

        var combinations = generateCombinations();
        $('#compCount').text('Count: ' + combinations.length);

        // Show in table
        $('#combinationsTable').find('tbody').empty();
        combinations.forEach(c => {
            var compUtil = combinationUtility(c);
            var $tr = $('<tr>');
            var $combinationTd = $('<td>');
            var $buffsTd = $('<td>');
            var $utilTd = $('<td>');
            var buffOptions = ['Stam', 'MotW', 'AI', 'BL', 'PI', 'Atrophic', 'Chaos Brand', 'Mystic Touch', 'BS'];
            var utilOptions = ['CR', 'CC', 'Dispell', 'Soothe'];


            for (var i = 0; i < 5; i++) {
                if (i == 1 || i == 2) {
                    $combinationTd.append(
                        $('<span>').css('display', 'inline-block').css('width', '10px')
                    );
                }
                $combinationTd.append(
                    $('<img>').attr('src', c[i].icon)
                );
            }
            $tr.append($combinationTd);
            $tr.append($('<td>').text(Math.floor(compUtil.interruptsPrMinute)));

            // Buffs
            buffOptions.forEach(u => {
                var bgColor = compUtil.buffs.includes(u) ? 'bg-success' : 'bg-danger';
                var $buffIcon = $('<img>').attr('src', getIcon(u)).attr('title', u);
                if (!compUtil.buffs.includes(u))
                    $buffIcon.css('filter', 'grayscale(100%)').css('opacity', '0.3')
                // $buffsTd.append($('<span class="badge ' + bgColor + '">').text(u));
                $buffsTd.append($buffIcon);
            });
            $tr.append($buffsTd);

            // Utility
            utilOptions.forEach(u => {
                var utilCount = compUtil.utils.filter((util) => util == u).length;

                var $img = $('<img>').attr('src', getIcon(u));
                if (utilCount == 0)
                    $img.css('filter', 'grayscale(100%)').css('opacity', '0.3')

                var $icon = $('<div class="icon-container">')
                    .attr('title', u)
                    .append($img)
                    .append($('<div class="icon-centered">').text(utilCount));



                $utilTd.append($('<div>').css('width', '40px').css('display', 'inline-block').append($icon));

                // console.log(compUtil.utils);

                // console.log(compUtil.utils.reduce((count, v) => v == 'CR' ? count++ : 0))
            });

            $tr.append($utilTd);

            $('#combinationsTable').find('tbody').append($tr)
        });
    }

    function ApplyClassColorsToSelected() {
        $('.select2-selection__choice').each((i, e) => {
            var id = $(e).children('.select2-selection__choice__display').attr('id');
            var wowclass = id.substring(id.indexOf('_') + 1, id.lastIndexOf('_'));
            $(e).addClass('bg-' + wowclass);
        });
    }

    function generateCombinations() {
        var playerSpecs = [];
        $('.specSelect').each(function (i, ss) {
            var specs = $(ss).find(':selected').map((i, s) => $(s).data('normalized')).get();
            playerSpecs.push(specs);
        });

        var allCombinations = generateCombinationsRecursive(playerSpecs);
        var validCombinations = [];

        allCombinations.forEach(c => {

            // Validate 1tank & 1healer
            var tankCount = c.filter(x => x.startsWith("tank_")).length;
            var healerCount = c.filter(x => x.startsWith("healer_")).length;
            if (tankCount != 1 || healerCount != 1)
                return;

            // Remove dublicates
            var wowclasses = c.map(x => x.substring(x.indexOf('_') + 1, x.lastIndexOf('_')))
            var dublicates = wowclasses.filter((item, index) => wowclasses.indexOf(item) !== index);
            if (dublicates.length > 0)
                return;


            // Sorting tank > healer > melee > ranged
            c = [c.filter(x => x.startsWith('tank_')), c.filter(x => x.startsWith('healer_')), c.filter(x => x.startsWith('melee_')), c.filter(x => x.startsWith('ranged_'))].flat();
            validCombinations.push(c.map(x => getSpec(x)));
        });

        return validCombinations;
    }

    function generateCombinationsRecursive(list, n = 0, result = [], current = []) {
        if (n === list.length)
            result.push(current)
        else
            list[n].forEach(item => generateCombinationsRecursive(list, n + 1, result, [...current, item]))

        return result
    }

    function getSpec(key) {
        var wowclassKey = key.substring(key.indexOf('_') + 1, key.lastIndexOf('_')); // rogue, druid, mage
        var specKey = key.substring(key.lastIndexOf('_') + 1); // outlaw, feral, fire
        var wowclass = classesJson.filter(x => x.name.toLowerCase() == wowclassKey.replace('_', ' '))[0]
        var spec = classesJson.filter(x => x.name.toLowerCase() == wowclassKey.replace('_', ' '))[0].specs.filter(x => x.name.toLowerCase() == specKey)[0]

        var result = { ...spec }
        result.key = key;
        result.role = key.substring(0, key.indexOf('_'));;
        result.class = wowclass.name;
        result.icon = 'https://assets.rpglogs.com/img/warcraft/icons/large/' + wowclass.name.replace(' ', '') + '-' + spec.name + '.jpg';
        result.interrupts = (spec.interrupts ?? []).concat(wowclass.interrupts ?? []);
        result.buffs = (spec.buffs ?? []).concat(wowclass.buffs ?? []);
        result.utils = (spec.utils ?? []).concat(wowclass.utils ?? []);

        return result;
    }

    function combinationUtility(players) {
        var interrupts = [];
        var buffs = [];
        var utils = [];

        for (var i = 0; i < players.length; i++) {
            interrupts = interrupts.concat(players[i].interrupts);
            buffs = buffs.concat(players[i].buffs);
            utils = utils.concat(players[i].utils);
        }

        return {
            interrupts: interrupts,
            buffs: buffs,
            utils: utils,
            interruptsPrMinute: interrupts.reduce((v, a) => 60 / a + v, 0)
        }
    }

    function getIcon(key) {
        switch (key.toLowerCase()) {
            case 'stam': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_holy_wordfortitude.jpg';
            case 'ai': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_holy_magicalsentry.jpg';
            case 'bl': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_nature_bloodlust.jpg';
            case 'motw': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_nature_regeneration.jpg';
            case 'pi': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_holy_powerinfusion.jpg';
            case 'atrophic': return 'https://wow.zamimg.com/images/wow/icons/medium/ability_rogue_nervesofsteel.jpg';
            case 'mystic touch': return 'https://wow.zamimg.com/images/wow/icons/medium/ability_monk_sparring.jpg';
            case 'chaos brand': return 'https://wow.zamimg.com/images/wow/icons/medium/ability_demonhunter_empowerwards.jpg';
            case 'bs': return 'https://wow.zamimg.com/images/wow/icons/medium/ability_warrior_battleshout.jpg';
            case 'cr': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_nature_reincarnation.jpg';
            case 'cc': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_nature_polymorph.jpg';
            case 'dispell': return 'https://wow.zamimg.com/images/wow/icons/medium/spell_arcane_massdispel.jpg';
            case 'soothe': return 'https://wow.zamimg.com/images/wow/icons/medium/ability_hunter_beastsoothe.jpg';
            default: return 'https://wow.zamimg.com/images/wow/icons/medium/inv_misc_questionmark.jpg';
        }
    }
</script>


<script>
    var classesJson = [
        {
            "name": "Death Knight",
            "specs": [
                { "role": "Tank", "name": "Blood" },
                { "role": "Melee", "name": "Frost" },
                { "role": "Melee", "name": "Unholy" }
            ],
            "interrupts": [15],
            "buffs": [],
            "utils": ["CR", "Group defensive"],
            "stops": [60]
        },
        {
            "name": "Demon Hunter",
            "specs": [
                { "role": "Tank", "name": "Vengeance", "interrupts": [60], "stops": [60] },
                { "role": "Melee", "name": "Havoc" }
            ],
            "interrupts": [15],
            "buffs": "Chaos Brand",
            "utils": ["CC", "Group defensive"],
            "stops": [45, 90]
        },
        {
            "name": "Druid",
            "specs": [
                { "role": "Tank", "name": "Guardian", "interrupts": [15] },
                { "role": "Healer", "name": "Restoration", "utils": ["Dispell"] },
                { "role": "Melee", "name": "Feral", "interrupts": [15] },
                { "role": "Ranged", "name": "Balance", "interrupts": [60] }
            ],
            "interrupts": [],
            "buffs": ["MotW"],
            "utils": ["CR", "CC", "Dispell", "Soothe"],
            "stops": [30, 90]
        },
        {
            "name": "Evoker",
            "specs": [
                { "role": "Healer", "name": "Preservation", "interrupts": [40], "stops": [90, 90] },
                { "role": "Ranged", "name": "Devastation", "interrupts": [20], "stops": [90, 90] },
                { "role": "Ranged", "name": "Augmentation", "interrupts": [18], "stops": [41, 81, 108, 36] }
            ],
            "interrupts": [],
            "buffs": ["BL"],
            "utils": ["Dispell", "Soothe", "CC", "Group defensive"],
            "stops": []
        },
        {
            "name": "Hunter",
            "specs": [
                { "role": "Melee", "name": "Survival", "interrupts": [15] },
                { "role": "Ranged", "name": "BeastMaster", "interrupts": [24] },
                { "role": "Ranged", "name": "Marksmanship", "interrupts": [24] }
            ],
            "interrupts": [],
            "buffs": ["BL"],
            "utils": ["CC", "Soothe"],
            "stops": []
        },
        {
            "name": "Mage",
            "specs": [
                { "role": "Ranged", "name": "Arcane" },
                { "role": "Ranged", "name": "Frost" },
                { "role": "Ranged", "name": "Fire" }
            ],
            "interrupts": [24],
            "buffs": ["BL", "AI"],
            "utils": ["shroud", "CC", "Dispell", "Group defensive"],
            "stops": [30, 45]
        },
        {
            "name": "Monk",
            "specs": [
                { "role": "Tank", "name": "Brewmaster" },
                { "role": "Healer", "name": "Mistweaver", "utils": ["Group defensive"] },
                { "role": "Melee", "name": "Windwalker" }
            ],
            "interrupts": [15],
            "buffs": ["Mystic Touch"],
            "utils": ["CC", "Dispell"],
            "stops": [60, 45]
        },
        {
            "name": "Paladin",
            "specs": [
                { "role": "Tank", "name": "Protection", "interrupts": [15] },
                { "role": "Healer", "name": "Holy" },
                { "role": "Melee", "name": "Retribution" }
            ],
            "interrupts": [15],
            "buffs": [],
            "utils": ["CR", "CC", "Dispell"],
            "stops": [90]
        },
        {
            "name": "Priest",
            "specs": [
                { "role": "Healer", "name": "Holy" },
                { "role": "Healer", "name": "Discipline", "utils": ["Group defensive"] },
                { "role": "Ranged", "name": "Shadow", "interrupts": [24] }
            ],
            "interrupts": [],
            "buffs": ["Stam", "PI"],
            "utils": ["Dispell", "CC"],
            "stops": [45]
        },
        {
            "name": "Rogue",
            "specs": [
                { "role": "Melee", "name": "Assassination" },
                { "role": "Melee", "name": "Outlaw" },
                { "role": "Melee", "name": "Subtlety" }
            ],
            "interrupts": [15],
            "buffs": ["Atrophic"],
            "utils": ["shroud", "Soothe"],
            "stops": [60]
        },
        {
            "name": "Shaman",
            "specs": [
                { "role": "Healer", "name": "Restoration" },
                { "role": "Melee", "name": "Enhancement", "stops": [40] },
                { "role": "Ranged", "name": "Elemental" }
            ],
            "interrupts": [12],
            "buffs": ["BL"],
            "utils": ["Dispell", "CC"],
            "stops": [30, 60]
        },
        {
            "name": "Warlock",
            "specs": [
                { "role": "Ranged", "name": "Affliction" },
                { "role": "Ranged", "name": "Demonology" },
                { "role": "Ranged", "name": "Destruction" }
            ],
            "interrupts": [24],
            "buffs": [],
            "utils": ["CR", "CC", "Dispell"],
            "stops": [60]
        },
        {
            "name": "Warrior",
            "specs": [
                { "role": "Tank", "name": "Protection" },
                { "role": "Melee", "name": "Arms" },
                { "role": "Melee", "name": "Fury" }
            ],
            "interrupts": [15],
            "buffs": ["BS"],
            "utils": ["Group defensive"],
            "stops": [40]
        }
    ];
</script>
</html>